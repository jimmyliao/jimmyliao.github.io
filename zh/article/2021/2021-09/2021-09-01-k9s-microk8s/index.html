<!doctype html><html itemscope itemtype=https://schema.org/WebPage class=no-js lang=zh><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=siteBaseUrl content="https://jimmyliao.net"><meta name=author content="JimmyLiao"><meta name=description content="JimmyLiao Notes Blog"><meta name=keywords content="jimmyliao,personal,runner,fullstack,cloud,mobile,architect"><meta name=generator content="Hugo 0.111.3"><title>如何連到遠端的 MicroK8s 並用 K9S monitoring | JimmyLiao</title><meta itemprop=name content="如何連到遠端的 MicroK8s 並用 K9S monitoring"><meta itemprop=description content="HOWTO: connect to remote microk8s"><meta property="og:site_name" content="JimmyLiao"><meta property="og:title" content="如何連到遠端的 MicroK8s 並用 K9S monitoring"><meta property="og:description" content="HOWTO: connect to remote microk8s"><meta property="og:type" content="article"><meta property="og:url" content="https://jimmyliao.net/zh/article/2021/2021-09/2021-09-01-k9s-microk8s/"><meta property="article:section" content="article"><meta property="article:published_time" content="2021-09-02T22:47:55+08:00"><meta property="article:modified_time" content="2021-09-02T22:47:55+08:00"><meta property="og:site_name" content="JimmyLiao"><script src=/modernizr-simple.js></script>
<link href=/zh/article/2021/2021-09/2021-09-01-k9s-microk8s/ rel=alternate type=application/rss+xml title=JimmyLiao><link href=/zh/article/2021/2021-09/2021-09-01-k9s-microk8s/ rel=feed type=application/rss+xml title=JimmyLiao><link rel=canonical href=https://jimmyliao.net/zh/article/2021/2021-09/2021-09-01-k9s-microk8s/><link rel=stylesheet href=https://jimmyliao.net/theme.css></head><body class=bilberry-hugo-theme><nav><div class=container><ul class=topnav></ul><div id=search-box class=search><i class="fas fa-search"></i>
<input id=search type=text placeholder="Search ..."></div></div></nav><header><div class=container><div class=logo><a href=/zh class=logo><img src=/images/fb_share.jpg alt>
<span class=overlay><i class="fa fa-home"></i></span></a></div><div class=titles><h3 class=title><a href=/zh>JimmyLiao</a></h3><span class=subtitle>JimmyLiao 筆記: 技術，生活，跑步，閱讀</span></div><div class=languages><a href=/>en</a>
<a href=/zh/article/2021/2021-09/2021-09-01-k9s-microk8s/ class=active>zh</a></div><div class=toggler><i class="fa fa-bars" aria-hidden=true></i></div></div></header><div class="main container"><div class="article-wrapper u-cf single"><a class=bubble href=https://jimmyliao.net/zh/article/2021/2021-09/2021-09-01-k9s-microk8s/><i class="fas fa-fw fa-pencil-alt"></i></a><article class="default article"><div class=content><h1 class=article-title><a href=https://jimmyliao.net/zh/article/2021/2021-09/2021-09-01-k9s-microk8s/>如何連到遠端的 MicroK8s 並用 K9S monitoring</a></h1><div class=meta><span class="date moment">2021-09-02</span>
<span class=categories><a href=https://jimmyliao.net/zh/categories/kubernetes/>Kubernetes</a></span></div><p><strong>如何連到遠端的 MicroK8s 並用 K9S 快快樂樂的管理 Kubernetes</strong></p><p>使用 kubectl command 管理 Kubernetes Cluter 為工程師基本技能，用久了自然而然就想找些更適合習慣 Terminal 操作但又想有點 hacky 的介面，從強者同事分享的工具集才發現根本是超讚的東西阿！</p><p>前置作業：
大致上就是在 AWS 上面開個 EC2 instance，裝個 Ubuntu 20.04 Server Edition，其他就照 K9S 跟 MicroK8s 官網安裝。(秘技: 其實裝個 <a href=(https://docs.primehub.io/docs/getting_started/kubernetes_on_ubuntu_ce)>PrimeHub CE</a> 照著步驟到 <a href=https://docs.primehub.io/docs/getting_started/kubernetes_on_ubuntu_ce#quick-verification>Quick Verification</a> 也是更快的選項)</p><p>你應該可以 ssh 到這台 EC2，輸入 <code>k9s</code></p><p>驗證在該台主機上可以透過 K9S 看到 Cluster 資訊沒問題！</p><p>接著來到這篇的主題：透過 laptop 連到遠端的主機</p><p>首先，你會發現即使你知道主機的 public IP，嘗試透過 <code>~/.kube/config</code> 並放到 laptop 的 kube config</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>~$ cat ~/.kube/config
</span></span><span style=display:flex><span>apiVersion: v1
</span></span><span style=display:flex><span>clusters:
</span></span><span style=display:flex><span>- cluster:
</span></span><span style=display:flex><span>    certificate-authority-data: &lt;YOUR_CERT_DATA&gt;
</span></span><span style=display:flex><span>    server: https://127.0.0.1:16443
</span></span><span style=display:flex><span>  name: microk8s-cluster
</span></span><span style=display:flex><span>contexts:
</span></span><span style=display:flex><span>- context:
</span></span><span style=display:flex><span>    cluster: microk8s-cluster
</span></span><span style=display:flex><span>    user: admin
</span></span><span style=display:flex><span>  name: microk8s
</span></span><span style=display:flex><span>current-context: microk8s
</span></span><span style=display:flex><span>kind: Config
</span></span><span style=display:flex><span>preferences: <span style=color:#f92672>{}</span>
</span></span><span style=display:flex><span>users:
</span></span><span style=display:flex><span>- name: admin
</span></span><span style=display:flex><span>  user:
</span></span><span style=display:flex><span>    token: &lt;YOUR_-_TOKEN&gt;
</span></span></code></pre></div><p>修改對應的 <code>server: https://&lt;EC2_PUBLIC_IP>:16443</code> ，也打開 EC2 上的 <code>16443</code> port</p><p>發現怎麼在打 <code>kubectl get node</code> 時找不到</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>Unable to connect to the server: x509: certificate is valid <span style=color:#66d9ef>for</span> 127.0.0.1, 10.152.183.1, 192.168.1.123, not &lt;EC2_PUBLIC_IP&gt;
</span></span></code></pre></div><p>記得先檢查 MicroK8s 的 metrics-server 有沒有 enabled。有 enabled 的話才不會在 K9S 上面看到 CPU/MEM 是 n/a</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>~$ microk8s status
</span></span><span style=display:flex><span>microk8s is running
</span></span><span style=display:flex><span>high-availability: no
</span></span><span style=display:flex><span>  datastore master nodes: 127.0.0.1:19001
</span></span><span style=display:flex><span>  datastore standby nodes: none
</span></span><span style=display:flex><span>addons:
</span></span><span style=display:flex><span>  enabled:
</span></span><span style=display:flex><span>    dns                  <span style=color:#75715e># CoreDNS</span>
</span></span><span style=display:flex><span>    ha-cluster           <span style=color:#75715e># Configure high availability on the current node</span>
</span></span><span style=display:flex><span>    metrics-server       <span style=color:#75715e># K8s Metrics Server for API access to service metrics</span>
</span></span><span style=display:flex><span>    rbac                 <span style=color:#75715e># Role-Based Access Control for authorisation</span>
</span></span><span style=display:flex><span>    storage              <span style=color:#75715e># Storage class; allocates storage from host directory</span>
</span></span></code></pre></div><p>然後找了一些文件，有一說是在kube-apiserver設定檔案，新增 <code>--bind-address</code>，像是<a href=https://microk8s.io/docs/external-lma>這個</a> 跟 <a href=https://discuss.kubernetes.io/t/microk8s-with-an-external-lma/13595>這個</a>。重啟 MicroK8s 之後沒什麼幫助。直到我找到 <a href=https://discuss.kubernetes.io/t/is-there-a-way-to-access-microk8s-using-kubectl-outside-the-local-network/15488>這篇</a>，內容大意是說，像是 EC2 這種 instance 的 Public IP 並沒有實際在 network interface 指定，而是透過 EC2 方式給定一組 Public IP 指定給這個 instance，就需要在 <code>/var/snap/microk8s/current/certs/csr.conf.template</code> 裡面新增一個 IP</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#f92672>[</span> alt_names <span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>DNS.1 <span style=color:#f92672>=</span> kubernetes
</span></span><span style=display:flex><span>DNS.2 <span style=color:#f92672>=</span> kubernetes.default
</span></span><span style=display:flex><span>DNS.3 <span style=color:#f92672>=</span> kubernetes.default.svc
</span></span><span style=display:flex><span>DNS.4 <span style=color:#f92672>=</span> kubernetes.default.svc.cluster
</span></span><span style=display:flex><span>DNS.5 <span style=color:#f92672>=</span> kubernetes.default.svc.cluster.local
</span></span><span style=display:flex><span>IP.1 <span style=color:#f92672>=</span> 127.0.0.1
</span></span><span style=display:flex><span>IP.2 <span style=color:#f92672>=</span> 10.152.183.1
</span></span><span style=display:flex><span>IP.99 <span style=color:#f92672>=</span> &lt;EC2_PUBLIC_IP&gt;
</span></span><span style=display:flex><span><span style=color:#75715e>#MOREIPS</span>
</span></span></code></pre></div><p>記得這裡千萬別自認為要直接指定 <code>IP.3</code> ，而是要指定從 <code>IP.100</code> 或是往下遞減，這邊先給個 <code>IP.99</code>。</p><p>改好並 restart microk8s 之後就可以遠端執行 <code>kubectl</code> 啦！</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>~$ kubectl get node
</span></span><span style=display:flex><span>NAME            STATUS   ROLES    AGE    VERSION
</span></span><span style=display:flex><span>ip-10-40-0-11   Ready    &lt;none&gt;   4d1h   v1.19.13-34+939585d5fb6fa7
</span></span></code></pre></div><p>然後就可以快快樂樂的在 laptop 直接監控 Cluster 囉～</p><p><img src=/images/2021-09-01-k9s.png alt></p></div><div class=footer><div class=tags><i class="fa fa-tags"></i><div class=links><a href=https://jimmyliao.net/zh/tags/kubernetes/>Kubernetes</a>
<a href=https://jimmyliao.net/zh/tags/k9s/>K9S</a>
<a href=https://jimmyliao.net/zh/tags/microk8s/>MicroK8s</a></div></div></div></article></div><div id=comments-container><div id=disqus_thread></div><script type=application/javascript>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//jimmyliao.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div></div><footer><div class=container><div class=recent-posts><strong>Latest posts</strong><ul><li><a href=https://jimmyliao.net/zh/article/2023/2023-03/2023-03-29-azure-lang-studio-ner-gpt/>在 Azure Language Studio 使用 GPT 模型加速 Labeling 工作</a></li><li><a href=https://jimmyliao.net/zh/article/2023/2023-03/2023-03-14-hugo-theme-bilberry/>更換 Hugo 主題</a></li><li><a href=https://jimmyliao.net/zh/article/2023/2023-02/2023-02-24-bingchat/>New Bing / Bing Chat 原來可以這樣用</a></li><li><a href=https://jimmyliao.net/zh/article/2023/2023-02/2023-02-16-aoai-training-module/>Azure OpenAI Part 7: Azure 學習模組 OpenAI 服務簡介</a></li><li><a href=https://jimmyliao.net/zh/article/2023/2023-02/2023-02-12-openai-parameters/>Azure OpenAI Part 6: GPT-3 裡面的微調參數 - 溫度 (temperature)</a></li><li><a href=https://jimmyliao.net/zh/article/2023/2023-02/2023-02-11-openai-pricing/>Azure OpenAI Part 5: 從 OpenAI 收費與 Token 計算方式，看看 ChatGPT Plus 的收費合理嗎？</a></li><li><a href=https://jimmyliao.net/zh/article/2023/2023-02/2023-02-01-azure-openai-intro/>Azure OpenAI Part 4: Azure OpenAI 服務申請</a></li></ul></div><div class=categories><a href=https://jimmyliao.net/zh/categories/><strong>Categories</strong></a><ul><li><a href=https://jimmyliao.net/zh/categories/azure/>Azure (11)</a></li><li><a href=https://jimmyliao.net/zh/categories/openai/>OpenAI (7)</a></li><li><a href=https://jimmyliao.net/zh/categories/running/>Running (5)</a></li><li><a href=https://jimmyliao.net/zh/categories/windows/>Windows (5)</a></li><li><a href=https://jimmyliao.net/zh/categories/blog/>Blog (4)</a></li><li><a href=https://jimmyliao.net/zh/categories/hexo/>Hexo (2)</a></li><li><a href=https://jimmyliao.net/zh/categories/kubernetes/>Kubernetes (2)</a></li></ul></div><div class=right><div class=external-profiles><strong>Social media</strong>
<a href=https://www.linkedin.com/in/jimmyliao/ target=_blank rel><em class="fab fa-linkedin"></em></a>
<a href=https://twitter.com/jimmyliao target=_blank rel><em class="fab fa-twitter"></em></a>
<a href=https://github.com/jimmyliao target=_blank rel=me><em class="fab fa-github"></em></a>
<a href=https://fb.me/sjliao target=_blank rel><em class="fab fa-facebook"></em></a></div><div class=languages><strong>Other languages</strong>
<a href=/>en</a>
<a href=/zh/article/2021/2021-09/2021-09-01-k9s-microk8s/ class=active>zh</a></div><div class=archive><a href=https://jimmyliao.net/zh/archive/><strong>Archive</strong></a></div></div></div></footer><div class=credits><div class=container><div class=copyright><a href=https://github.com/jimmyliao target=_blank>&copy;
2023
by JimmyLiao</a></div><div class=author><a href=https://github.com/Lednerb/bilberry-hugo-theme target=_blank>Bilberry Hugo Theme</a></div></div></div><script async src="https://www.googletagmanager.com/gtag/js?id=G-Z8GF80P8LB"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-Z8GF80P8LB",{anonymize_ip:!1})}</script><script src=https://jimmyliao.net/theme.js></script><div id=activate-algolia-search class=hidden><input type=hidden id=algolia-search-appId value=45CEN6X6AT>
<input type=hidden id=algolia-search-apiKey value=16030625f1a4d0dd3b8aefd794fd4cf1>
<input type=hidden id=algolia-search-indexName value=bilberry-hugo-theme>
<input type=hidden id=algolia-search-noSearchResults value="Nothing found.">
<input type=hidden id=algolia-search-currentLanguageOnly></div></body></html>